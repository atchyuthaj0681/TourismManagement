@model TourismManagement.Models.ViewModels.BookingListViewModel

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Admin – Manage Bookings";
}

<h2>Admin – Manage Bookings</h2>

<form method="get" asp-action="Index" class="row mb-3 g-3 align-items-center">
    <div class="col-auto">
        <input type="text" name="userEmail" value="@Model.UserEmail" class="form-control" placeholder="Search by user email" />
    </div>

    <div class="col-auto">
        <select name="status" class="form-select">
            <option value="" selected="@(string.IsNullOrEmpty(Model.Status))">All Statuses</option>
            <option value="Booked" selected="@(Model.Status == "Booked")">Booked</option>
            <option value="Cancelled" selected="@(Model.Status == "Cancelled")">Cancelled</option>
        </select>
    </div>

    <div class="col-auto">
        <select name="packageId" class="form-select">
            <option value="" selected="@(Model.PackageId == null || Model.PackageId == 0)">All Packages</option>
            @foreach (var package in Model.Packages)
            {
                <option value="@package.Id" selected="@(Model.PackageId == package.Id)">@package.Title</option>
            }
        </select>
    </div>

    <div class="col-auto">
        <select name="sortOrder" class="form-select">
            <option value="desc" selected="@(Model.SortOrder == "desc")">Booking Date ↓</option>
            <option value="asc" selected="@(Model.SortOrder == "asc")">Booking Date ↑</option>
            <option value="amount_desc" selected="@(Model.SortOrder == "amount_desc")">Amount ↓</option>
            <option value="amount_asc" selected="@(Model.SortOrder == "amount_asc")">Amount ↑</option>
        </select>
    </div>

    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a asp-action="Index" class="btn btn-secondary ms-2">Reset</a>
    </div>

    <div class="col-auto ms-auto">
        <a asp-action="ExportCsv"
           asp-route-status="@Model.Status"
           asp-route-userEmail="@Model.UserEmail"
           asp-route-packageId="@Model.PackageId"
           asp-route-sortOrder="@Model.SortOrder"
           class="btn btn-outline-success">
            <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
        </a>
    </div>
</form>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>User Email</th>
            <th>Package</th>
            <th>Booking Date</th>
            <th>Travel Date</th>
            <th class="text-center">People</th>
            <th class="text-end">Total</th>
            <th class="text-center">Status</th>
            <th class="text-center">Cancellation</th>
            <th class="text-end">Refund</th>
            <th style="width: 100px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Bookings != null && Model.Bookings.Any())
        {
            foreach (var booking in Model.Bookings)
            {
                <tr>
                    <td>@booking.User.Email</td>
                    <td>@booking.Package.Title</td>
                    <td>@booking.BookingDate.ToString("MMM dd, yyyy h:mm tt")</td>
                    <td>@booking.TravelDate.ToString("MMM dd, yyyy")</td>
                    <td class="text-center">@booking.NumPeople</td>
                    <td class="text-end">@booking.TotalAmount.ToString("C")</td>
                    <td class="text-center">
                        <span class="badge @(booking.Status == "Booked" ? "bg-success" : "bg-secondary")">
                            @booking.Status
                        </span>
                    </td>
                    <td class="text-center">
                        @(booking.CancellationDate.HasValue? booking.CancellationDate.Value.ToString("MMM dd, yyyy") : "-")
                    </td>
                    <td class="text-end">
                        @(booking.RefundAmount.HasValue? booking.RefundAmount.Value.ToString("C") : "-")
                    </td>
                    <td>
                        <a asp-action="Details" asp-route-id="@booking.Id" class="btn btn-info btn-sm">View</a>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="10" class="text-center text-muted">No bookings found.</td>
            </tr>
        }
    </tbody>
</table>

<nav>
    <ul class="pagination">
        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Index", new { status = Model.Status, userEmail = Model.UserEmail, packageId = Model.PackageId, sortOrder = Model.SortOrder, page = Model.CurrentPage - 1 })">Previous</a>
        </li>

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                <a class="page-link" href="@Url.Action("Index", new { status = Model.Status, userEmail = Model.UserEmail, packageId = Model.PackageId, sortOrder = Model.SortOrder, page = i })">@i</a>
            </li>
        }

        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Index", new { status = Model.Status, userEmail = Model.UserEmail, packageId = Model.PackageId, sortOrder = Model.SortOrder, page = Model.CurrentPage + 1 })">Next</a>
        </li>
    </ul>
</nav>
