@model TourismManagement.Models.ViewModels.BookingListViewModel

@{
    ViewData["Title"] = "Manage Bookings";
}

<h2 class="mb-4 text-primary fw-bold">@ViewData["Title"]</h2>

<!-- Filter Form -->
<form method="get" class="row g-3 mb-4 align-items-end">
    <div class="col-md-3">
        <label>Status</label>
        <select name="status" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="Booked" selected="@(Model.Status == "Booked")">Booked</option>
            <option value="Cancelled" selected="@(Model.Status == "Cancelled")">Cancelled</option>
        </select>
    </div>

    <div class="col-md-3">
        <label>User Email</label>
        <input type="text" name="userEmail" value="@Model.UserEmail" class="form-control form-control-sm" placeholder="Search email" />
    </div>

    <div class="col-md-3">
        <label>Package</label>
        <select name="packageId" class="form-select form-select-sm">
            <option value="">All Packages</option>
            @foreach (var package in Model.Packages ?? Enumerable.Empty<TourismManagement.Models.Package>())
            {
                <option value="@package.Id" selected="@(Model.PackageId == package.Id)">@package.Title</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label>Sort by</label>
        <select name="sortOrder" class="form-select form-select-sm">
            <option value="date_desc" selected="@(Model.SortOrder == "date_desc")">Booking Date ↓</option>
            <option value="date_asc" selected="@(Model.SortOrder == "date_asc")">Booking Date ↑</option>
            <option value="amount_desc" selected="@(Model.SortOrder == "amount_desc")">Amount ↓</option>
            <option value="amount_asc" selected="@(Model.SortOrder == "amount_asc")">Amount ↑</option>
        </select>
    </div>

    <div class="col-md-3">
        <button type="submit" class="btn btn-primary btn-sm mt-2">Filter</button>
        <a asp-action="Index" class="btn btn-secondary btn-sm mt-2 ms-1">Reset</a>
    </div>
</form>

<!-- Bookings Table -->
<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>User</th>
                <th>Package</th>
                <th>Travel Date</th>
                <th>Booking Date</th>
                <th>People</th>
                <th>Total</th>
                <th>Status</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var booking in Model.Bookings)
            {
                <tr>
                    <td>@booking.User.Email</td>
                    <td>@booking.Package.Title</td>
                    <td>@booking.TravelDate.ToString("yyyy-MM-dd")</td>
                    <td>@booking.BookingDate.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@booking.NumPeople</td>
                    <td>@booking.TotalAmount.ToString("C")</td>
                    <td>
                        @if (booking.Status == "Cancelled")
                        {
                            <span class="badge bg-danger">Cancelled</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Booked</span>
                        }
                    </td>
                    <td class="text-center">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Actions
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" asp-action="BookingDetails" asp-route-id="@booking.Id">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" asp-action="EditBooking" asp-route-id="@booking.Id">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>
                                </li>
                                @if (booking.Status == "Booked" && booking.TravelDate > DateTime.Now)
                                {
                                    <li>
                                        <button type="button"
                                                class="dropdown-item text-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#cancelModal"
                                                data-bookingid="@booking.Id"
                                                data-packagetitle="@booking.Package.Title"
                                                data-traveldate="@booking.TravelDate.ToString("yyyy-MM-dd")">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                    </li>
                                }
                            </ul>
                        </div>
                    </td>

                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form asp-action="CancelBooking" method="post">
            <input type="hidden" name="id" id="bookingId" />
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelModalLabel">Confirm Cancellation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel the booking for:</p>
                    <ul>
                        <li><strong>Package:</strong> <span id="packageTitle"></span></li>
                        <li><strong>Travel Date:</strong> <span id="travelDate"></span></li>
                    </ul>
                    <p class="text-danger fw-bold">Note: Cancellation may incur charges as per policy.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">No, Keep It</button>
                    <button type="submit" class="btn btn-danger">Yes, Cancel Booking</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const cancelModal = document.getElementById('cancelModal');
        cancelModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const bookingId = button.getAttribute('data-bookingid');
            const packageTitle = button.getAttribute('data-packagetitle');
            const travelDate = button.getAttribute('data-traveldate');

            document.getElementById('bookingId').value = bookingId;
            document.getElementById('packageTitle').textContent = packageTitle;
            document.getElementById('travelDate').textContent = travelDate;
        });
    </script>
}
